name: benchmarks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  pull_request_target:
    branches: [main]

concurrency:
  group: benchmarks-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  bench:
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - uses: Swatinem/rust-cache@v2
        with:
          env-vars: "RUST_TOOLCHAIN=stable"

      - name: Prepare dirs
        run: |
          mkdir -p benchmarks/baselines
          mkdir -p /tmp/benchmarks/out

      - name: Fetch main for PR baseline reads
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin main:refs/remotes/origin/main

      - name: Run all benchmark scripts
        shell: bash
        run: |
          set -euo pipefail

          shopt -s nullglob
          scripts=(scripts/bench/*.py)

          if [ ${#scripts[@]} -eq 0 ]; then
            echo "No benchmark scripts found in scripts/bench/*.py"
            exit 0
          fi

          is_main="false"
          if [ "${GITHUB_EVENT_NAME}" = "push" ] && [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            is_main="true"
          fi

          for script in "${scripts[@]}"; do
            base="$(basename "$script" .py)"
            baseline_repo_path="benchmarks/baselines/${base}.json"
            baseline_tmp_path="/tmp/benchmarks/out/${base}.baseline.json"
            report_path="/tmp/benchmarks/out/${base}.report.txt"

            echo
            echo "Running benchmark: $base"

            if [ "$is_main" = "true" ]; then
              python3 "$script" --json-out "$baseline_repo_path"
              continue
            fi

            have_baseline="false"
            if git cat-file -e "origin/main:${baseline_repo_path}" 2>/dev/null; then
              git show "origin/main:${baseline_repo_path}" > "$baseline_tmp_path"
              have_baseline="true"
            fi

            if [ "$have_baseline" = "true" ]; then
              python3 "$script" --compare-to "$baseline_tmp_path" > "$report_path"
            else
              python3 "$script" > "$report_path"
            fi
          done

      - name: Commit updated baselines on main
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage anything that changed or was created under baselines
          git add -A benchmarks/baselines

          # If nothing staged, exit cleanly
          if git diff --cached --quiet; then
            echo "No baseline changes to commit"
            exit 0
          fi

          git commit -m "chore: update benchmark baselines"
          git push

      - name: Build combined PR comment
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail

          shopt -s nullglob
          reports=(/tmp/benchmarks/out/*.report.txt)

          out="/tmp/bench_comment.md"

          {
            echo "## Benchmarks"
            echo
            echo "Updated on every push to this PR."
            echo
            echo "Baselines are read from main under benchmarks/baselines when available."
            echo
          } > "$out"

          if [ ${#reports[@]} -eq 0 ]; then
            {
              echo "No benchmark reports were produced."
              echo
              echo "Expected scripts in scripts/bench/*.py"
            } >> "$out"
            exit 0
          fi

          for report in "${reports[@]}"; do
            base="$(basename "$report" .report.txt)"
            {
              echo "### ${base}"
              echo
              echo "Script"
              echo
              echo '```'
              echo "python3 scripts/bench/${base}.py"
              echo '```'
              echo
              echo "Output"
              echo
              echo '```'
              cat "$report"
              echo '```'
              echo
            } >> "$out"
          done

      - name: Upload PR comment artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: bench-comment-pr${{ github.event.pull_request.number }}-sha${{ github.event.pull_request.head.sha }}
          path: /tmp/bench_comment.md
          retention-days: 7

      - name: Post or update PR comment (same repo PRs only)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: benchmarks
          path: /tmp/bench_comment.md

  comment_fork:
    if: github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read
      actions: read

    steps:
      - name: Download PR artifact from pull_request run via API
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          WORKFLOW_FILE: e2eBenchmarks.yml
        run: |
          set -euo pipefail

          artifact_name="bench-comment-pr${PR_NUMBER}-sha${HEAD_SHA}"
          echo "Looking for artifact: ${artifact_name}"

          run_id=""

          # Poll for the pull_request workflow run that matches this head sha
          for i in $(seq 1 60); do
            runs_json="$(gh api -H "Accept: application/vnd.github+json" \
              "/repos/${REPO}/actions/workflows/${WORKFLOW_FILE}/runs?event=pull_request&head_sha=${HEAD_SHA}&per_page=10")"

            run_id="$(echo "$runs_json" | python3 -c "import sys, json; d=json.load(sys.stdin); w=d.get('workflow_runs', []); print(w[0]['id'] if w else '')")"
            run_status="$(echo "$runs_json" | python3 -c "import sys, json; d=json.load(sys.stdin); w=d.get('workflow_runs', []); print(w[0].get('status','') if w else '')")"
            run_conclusion="$(echo "$runs_json" | python3 -c "import sys, json; d=json.load(sys.stdin); w=d.get('workflow_runs', []); print(w[0].get('conclusion','') if w else '')")"

            if [ -n "$run_id" ] && [ "$run_status" = "completed" ]; then
              echo "Found completed pull_request run_id=${run_id} conclusion=${run_conclusion}"
              break
            fi

            echo "Waiting for pull_request run to complete, attempt ${i}"
            sleep 5
          done

          if [ -z "$run_id" ]; then
            echo "Could not find a completed pull_request workflow run for sha ${HEAD_SHA}"
            exit 1
          fi

          artifacts_json="$(gh api -H "Accept: application/vnd.github+json" "/repos/${REPO}/actions/runs/${run_id}/artifacts")"

          artifact_id="$(echo "$artifacts_json" | python3 -c "import sys, json; d=json.load(sys.stdin); name=sys.argv[1]; arts=d.get('artifacts', []); m=[a for a in arts if a.get('name')==name]; print(m[0]['id'] if m else '')" "$artifact_name")"

          if [ -z "$artifact_id" ]; then
            echo "Artifact not found in run ${run_id}: ${artifact_name}"
            exit 1
          fi

          echo "Downloading artifact id=${artifact_id}"
          mkdir -p /tmp/bench_artifact
          gh api -H "Accept: application/vnd.github+json" \
            "/repos/${REPO}/actions/artifacts/${artifact_id}/zip" > /tmp/bench_artifact/artifact.zip

          unzip -o /tmp/bench_artifact/artifact.zip -d /tmp/bench_artifact

          if [ ! -f /tmp/bench_artifact/bench_comment.md ]; then
            echo "bench_comment.md not found in artifact"
            ls -la /tmp/bench_artifact
            exit 1
          fi

      - name: Post or update PR comment (fork PRs)
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: benchmarks
          path: /tmp/bench_artifact/bench_comment.md
